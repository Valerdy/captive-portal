# FreeRADIUS SQL Queries for Captive Portal Quota System
# Ce fichier contient les requêtes SQL personnalisées pour la vérification des quotas

# ============================================================================
# AUTHORIZE QUERIES
# ============================================================================

# Requête pour récupérer les informations d'authentification avec vérification du quota
authorize_check_query = "\
    SELECT id, username, attribute, value, op \
    FROM ${authcheck_table} \
    WHERE username = '%{SQL-User-Name}' \
    AND statut = 1 \
    ORDER BY id"

# Requête pour vérifier si le quota est dépassé
# Cette requête est utilisée dans la politique unlang
authorize_group_check_query = "\
    SELECT id, groupname, attribute, Value, op \
    FROM ${groupcheck_table} \
    WHERE groupname = '%{${group_attribute}}' \
    ORDER BY id"

authorize_reply_query = "\
    SELECT id, username, attribute, value, op \
    FROM ${authreply_table} \
    WHERE username = '%{SQL-User-Name}' \
    ORDER BY id"

authorize_group_reply_query = "\
    SELECT id, groupname, attribute, value, op \
    FROM ${groupreply_table} \
    WHERE groupname = '%{${group_attribute}}' \
    ORDER BY id"

# ============================================================================
# QUOTA CHECK QUERY
# ============================================================================

# Cette requête vérifie si l'utilisateur a dépassé son quota
# Retourne 1 si le quota est dépassé, 0 sinon
quota_check_query = "\
    SELECT \
        CASE \
            WHEN rc.quota IS NULL THEN 0 \
            WHEN rc.quota = 0 THEN 0 \
            WHEN COALESCE(usage.total_bytes, 0) >= rc.quota THEN 1 \
            ELSE 0 \
        END as quota_exceeded, \
        rc.quota as quota_limit, \
        COALESCE(usage.total_bytes, 0) as quota_used \
    FROM radcheck rc \
    LEFT JOIN ( \
        SELECT username, SUM(acctinputoctets + acctoutputoctets) as total_bytes \
        FROM radacct \
        WHERE username = '%{SQL-User-Name}' \
        GROUP BY username \
    ) usage ON rc.username = usage.username \
    WHERE rc.username = '%{SQL-User-Name}' \
    AND rc.attribute = 'Cleartext-Password' \
    LIMIT 1"

# ============================================================================
# SIMULTANEOUS USE CHECK
# ============================================================================

# Vérifie le nombre de sessions actives pour Simultaneous-Use
simul_count_query = "\
    SELECT COUNT(*) \
    FROM ${acct_table1} \
    WHERE username = '%{SQL-User-Name}' \
    AND acctstoptime IS NULL"

# ============================================================================
# ACCOUNTING QUERIES
# ============================================================================

accounting_onoff_query = "\
    UPDATE ${acct_table1} \
    SET acctstoptime = %{%{Acct-Delay-Time}:-%l}, \
        acctsessiontime = %{%{Acct-Session-Time}:-0}, \
        acctterminatecause = '%{Acct-Terminate-Cause}' \
    WHERE acctstoptime IS NULL \
    AND nasipaddress = '%{NAS-IP-Address}' \
    AND acctstarttime <= %l"

accounting_update_query = "\
    UPDATE ${acct_table1} \
    SET \
        framedipaddress = '%{Framed-IP-Address}', \
        acctsessiontime = '%{Acct-Session-Time}', \
        acctinputoctets = '%{%{Acct-Input-Gigawords}:-0}' << 32 | '%{%{Acct-Input-Octets}:-0}', \
        acctoutputoctets = '%{%{Acct-Output-Gigawords}:-0}' << 32 | '%{%{Acct-Output-Octets}:-0}', \
        acctupdatetime = %l \
    WHERE acctsessionid = '%{Acct-Session-Id}' \
    AND username = '%{SQL-User-Name}' \
    AND nasipaddress = '%{NAS-IP-Address}'"

accounting_update_query_alt = "\
    INSERT INTO ${acct_table1} \
        (acctsessionid, acctuniqueid, username, \
         nasipaddress, nasportid, nasporttype, \
         acctstarttime, acctupdatetime, \
         acctsessiontime, acctauthentic, \
         connectinfo_start, acctinputoctets, \
         acctoutputoctets, calledstationid, \
         callingstationid, servicetype, \
         framedprotocol, framedipaddress) \
    VALUES \
        ('%{Acct-Session-Id}', '%{Acct-Unique-Session-Id}', '%{SQL-User-Name}', \
         '%{NAS-IP-Address}', '%{%{NAS-Port-ID}:-%{NAS-Port}}', '%{NAS-Port-Type}', \
         %l, %l, \
         '%{Acct-Session-Time}', '%{Acct-Authentic}', \
         '', '%{%{Acct-Input-Gigawords}:-0}' << 32 | '%{%{Acct-Input-Octets}:-0}', \
         '%{%{Acct-Output-Gigawords}:-0}' << 32 | '%{%{Acct-Output-Octets}:-0}', '%{Called-Station-Id}', \
         '%{Calling-Station-Id}', '%{Service-Type}', \
         '%{Framed-Protocol}', '%{Framed-IP-Address}')"

accounting_start_query = "\
    INSERT INTO ${acct_table1} \
        (acctsessionid, acctuniqueid, username, \
         nasipaddress, nasportid, nasporttype, \
         acctstarttime, acctupdatetime, \
         acctauthentic, connectinfo_start, \
         calledstationid, callingstationid, \
         servicetype, framedprotocol, \
         framedipaddress) \
    VALUES \
        ('%{Acct-Session-Id}', '%{Acct-Unique-Session-Id}', '%{SQL-User-Name}', \
         '%{NAS-IP-Address}', '%{%{NAS-Port-ID}:-%{NAS-Port}}', '%{NAS-Port-Type}', \
         %l, %l, \
         '%{Acct-Authentic}', '%{Connect-Info}', \
         '%{Called-Station-Id}', '%{Calling-Station-Id}', \
         '%{Service-Type}', '%{Framed-Protocol}', \
         '%{Framed-IP-Address}')"

accounting_stop_query = "\
    UPDATE ${acct_table1} SET \
        acctstoptime = %l, \
        acctsessiontime = '%{Acct-Session-Time}', \
        acctinputoctets = '%{%{Acct-Input-Gigawords}:-0}' << 32 | '%{%{Acct-Input-Octets}:-0}', \
        acctoutputoctets = '%{%{Acct-Output-Gigawords}:-0}' << 32 | '%{%{Acct-Output-Octets}:-0}', \
        acctterminatecause = '%{Acct-Terminate-Cause}', \
        framedipaddress = '%{Framed-IP-Address}', \
        connectinfo_stop = '%{Connect-Info}' \
    WHERE acctsessionid = '%{Acct-Session-Id}' \
    AND username = '%{SQL-User-Name}' \
    AND nasipaddress = '%{NAS-IP-Address}'"
